<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PhysiqueRUSH</title>
  <link rel="icon" type="image/png" href="icon-192.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0d0d0d" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Poppins", Arial, sans-serif;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at center, #1a0000, #000);
      color: white;
      overflow: hidden;
    }

    /* === Gestion des √©crans === */
    .screen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      padding-top: 5vh;
      padding-bottom: 90px; /* place pour le bouton Retour */
    }

    .screen.active {
      display: flex;
    }

    /* --- Logo & titre --- */
    .logo {
      width: 120px;
      height: 120px;
      border-radius: 20%;
      box-shadow: 0 0 25px #ff000044, 0 0 60px #ff000022 inset;
      animation: logoPulse 3s infinite alternate;
      margin-bottom: 1rem;
      z-index: 2;
    }

    @keyframes logoPulse {
      from { box-shadow: 0 0 25px #ff000033, 0 0 70px #ff000011 inset; }
      to   { box-shadow: 0 0 45px #ff000077, 0 0 120px #ff000033 inset; }
    }

    h1 {
      font-size: 2.8rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #ff2b2b;
      text-shadow: 0 0 30px #ff000099;
      margin-bottom: 2rem;
      animation: glowPulse 3s infinite alternate;
      z-index: 2;
    }

    @keyframes glowPulse {
      from { text-shadow: 0 0 10px #ff1a1a; }
      to   { text-shadow: 0 0 45px #ff0000; }
    }

    /* --- Menus g√©n√©raux --- */
    .menu {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1.4rem;
      margin-top: 1rem;
      z-index: 2;
      width: 80%;
      max-width: 400px;
    }

    button {
      background: linear-gradient(145deg, #330000, #660000);
      border: 2px solid #ff2b2b;
      color: #fff;
      font-size: 1.15rem;
      font-weight: bold;
      padding: 1.2rem 0;
      width: 100%;
      border-radius: 20px;
      cursor: pointer;
      box-shadow: 0 0 18px rgba(255,0,0,0.5);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    button:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 0 24px rgba(255,0,0,0.7);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    /* --- Fond gazeux global (halo rouge statique) --- */
    .background-glow, .background-glow2 {
      position: absolute;
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, #ff000033 0%, transparent 70%);
      filter: blur(100px);
      z-index: 0;
    }

    .background-glow {
      top: -100px;
      left: -100px;
    }

    .background-glow2 {
      bottom: -150px;
      right: -150px;
      width: 800px;
      height: 800px;
      background: radial-gradient(circle, #ff222244 0%, transparent 70%);
    }

    /* --- Footer --- */
    footer {
      position: absolute;
      bottom: 12px;
      font-size: 0.8rem;
      color: #666;
      z-index: 2;
    }

    footer span {
      color: #ff3333;
      font-weight: bold;
    }

    /* --- Bouton retour --- */
    .back-btn {
      position: absolute;
      bottom: 60px;
      left: 16px;
      background: #660000aa;
      color: #fff;
      border: 1px solid #ff3333;
      border-radius: 10px;
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 0 10px #ff000055;
      transition: all 0.2s ease;
      width: auto;
      z-index: 5;
    }

    .back-btn:hover {
      background: #990000;
      transform: scale(1.05);
    }

    /* --- Textes secondaires --- */
    .subtitle {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #dddddd;
      text-align: center;
      max-width: 85%;
      z-index: 2;
    }

    .small-text {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: #bbbbbb;
      text-align: center;
      max-width: 90%;
      z-index: 2;
    }

    /* --- La Test Room --- */
    .testroom-container {
      margin-top: 0.5rem;
      width: 90%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      z-index: 2;
    }

    .testroom-container .menu {
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .test-btn {
      font-size: 1rem;
      padding: 0.9rem 0;
      text-transform: none;
      letter-spacing: 0.5px;
    }

    .test-btn span {
      font-size: 0.8rem;
      font-weight: normal;
      text-transform: none;
    }

    .test-form {
      width: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 0.8rem;
      margin-top: 1rem;
    }

    .test-input {
      width: 100%;
      padding: 0.8rem;
      border-radius: 12px;
      border: 1px solid #ff5555;
      background: #1a0000;
      color: #ffffff;
      font-size: 1rem;
      text-align: center;
      outline: none;
    }

    .test-buttons-row {
      display: flex;
      gap: 0.8rem;
      width: 100%;
    }

    .test-buttons-row button {
      flex: 1;
      font-size: 1rem;
      padding: 0.8rem 0;
    }

    /* --- Mon √âvolution / Radar --- */
    .evolution-container {
      margin-top: 0.5rem;
      width: 90%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.8rem;
      z-index: 2;
    }

    #evolution-radar {
      background: radial-gradient(circle at center, #220000, #000000);
      border-radius: 50%;
      box-shadow: 0 0 20px #ff000040;
    }

    /* --- √âcran Puissance de Pouss√©e --- */
    .push-container {
      margin-top: 0.5rem;
      width: 90%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      z-index: 2;
    }

    .push-video-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 0 18px rgba(255,0,0,0.6);
    }

    .push-video-wrapper iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border: 0;
    }

    .push-start-btn {
      max-width: 260px;
      font-size: 1.2rem;
    }

    /* --- Overlay plein √©cran pour le test Push --- */
    .fullscreen-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.92);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      text-align: center;
      padding: 1rem;
    }

    .fullscreen-overlay.active {
      display: flex;
    }

    .push-phase-text {
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 1rem;
      padding: 0.8rem 1rem;
      border-radius: 12px;
      background: rgba(255,0,0,0.18);
      border: 1px solid rgba(255,80,80,0.9);
      text-shadow: 0 0 8px rgba(0,0,0,0.7);
    }

    .push-video-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
      max-width: 480px;
    }

    .push-mini-video-wrapper {
      width: 60%;
      max-width: 260px;
    }

    .push-mini-video-wrapper iframe {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 12px;
      border: 0;
    }

    .push-palier-label {
      min-width: 140px;
      font-size: 0.9rem;
      text-align: left;
    }

    .push-count-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin: 0.5rem 0 1rem;
    }

    .push-count-label {
      font-size: 1rem;
    }

    .push-level-count {
      font-size: 2.6rem;
      font-weight: bold;
      text-shadow: 0 0 20px #ff0000;
      min-width: 90px;
      text-align: center;
    }

    .push-actions {
      display: flex;
      gap: 1rem;
      width: 100%;
      max-width: 320px;
      justify-content: center;
    }

    .push-ok-btn,
    .push-fail-btn {
      flex: 1;
      font-size: 1.2rem;
      padding: 1rem 0;
    }

    .push-ok-btn {
      background: linear-gradient(145deg, #006633, #00aa55);
      border-color: #00ff99;
    }

    .push-fail-btn {
      background: linear-gradient(145deg, #660000, #aa0000);
      border-color: #ff5555;
    }

    .push-next-text {
      margin-top: 0.5rem;
      min-height: 2rem; /* r√©serve l‚Äôespace m√™me vide */
    }
  </style>

  <!-- API Vimeo -->
  <script src="https://player.vimeo.com/api/player.js"></script>
</head>

<body>
  <!-- Fond gazeux -->
  <div class="background-glow"></div>
  <div class="background-glow2"></div>

  <!-- √âcran principal -->
  <section id="main-screen" class="screen active">
    <img src="icon-512.png" alt="Logo PhysiqueRUSH" class="logo" />
    <h1>PhysiqueRUSH</h1>

    <div class="menu">
      <button id="niveau">üí™ Mon Niveau</button>
      <button id="training">üî• Training Camp</button>
      <button id="improvise">‚ö° S√©ance Improvis√©e</button>
    </div>

    <footer>powered by <span>PhysiqueRUSH</span> ‚Äì Massive Impact</footer>
  </section>

  <!-- √âcran "Mon Niveau" -->
  <section id="niveau-screen" class="screen">
    <img src="icon-512.png" alt="Logo PhysiqueRUSH" class="logo" />
    <h1>PhysiqueRUSH</h1>

    <div class="menu">
      <button id="testroom">üî± La Test Room</button>
      <button id="evolution">üß¨ Mon √âvolution</button>
      <button id="historique">üèÜ Historique des Perfs</button>
    </div>

    <button class="back-btn" id="back-niveau">‚¨Ö Retour</button>

    <footer>powered by <span>PhysiqueRUSH</span> ‚Äì Massive Impact</footer>
  </section>

  <!-- √âcran "La Test Room" -->
  <section id="testroom-screen" class="screen">
    <img src="icon-512.png" alt="Logo PhysiqueRUSH" class="logo" />
    <h1>PhysiqueRUSH</h1>

    <div class="testroom-container">
      <p class="subtitle">
        Choisis un test, entre ton score et valide. Seul le <b>dernier r√©sultat</b> est utilis√© pour le radar.
      </p>

      <div class="menu" id="testroom-menu">
        <button class="test-btn" data-test="push">
          üí• Puissance de Pouss√©e<br><span>Test guid√© de puissance</span>
        </button>
        <button class="test-btn" data-test="pull">
          üõ° Capacit√© de Tirage<br><span>Endurance des muscles du dos</span>
        </button>
        <button class="test-btn" data-test="legs">
          ü¶µ R√©sistance des Jambes<br><span>Force & endurance des jambes</span>
        </button>
        <button class="test-btn" data-test="cardio">
          ‚ù§Ô∏è Potentiel Cardio<br><span>Capacit√© a√©robie globale</span>
        </button>
        <button class="test-btn" data-test="definition">
          üß± Niveau de D√©finition Musculaire<br><span>%BF (plus bas = mieux)</span>
        </button>
      </div>

      <div id="test-form" class="test-form">
        <h2 id="test-name">Test</h2>
        <input
          type="number"
          id="test-score"
          class="test-input"
          step="0.1"
          placeholder="Entre ton score"
        />
        <div class="test-buttons-row">
          <button id="save-test">‚úÖ Enregistrer</button>
          <button id="cancel-test">‚úñ Annuler</button>
        </div>
        <p class="small-text">
          Pour la <b>D√©finition</b>, saisis simplement ton <b>%BF actuel</b> (plus il est bas, mieux c'est).
        </p>
      </div>
    </div>

    <button class="back-btn" id="back-testroom">‚¨Ö Retour</button>

    <footer>powered by <span>PhysiqueRUSH</span> ‚Äì Massive Impact</footer>
  </section>

  <!-- √âcran "Puissance de Pouss√©e" -->
  <section id="push-screen" class="screen">
    <img src="icon-512.png" alt="Logo PhysiqueRUSH" class="logo" />
    <h1>PhysiqueRUSH</h1>

    <div class="push-container">
      <p class="subtitle">
        Test guid√© de <b>Puissance de Pouss√©e</b>. Regarde d'abord la vid√©o, puis lance le test.
      </p>

      <div class="push-video-wrapper">
        <iframe
          src="https://player.vimeo.com/video/XXXXXXXX"
          allow="autoplay; fullscreen; picture-in-picture"
          allowfullscreen
          title="Puissance de Pouss√©e - Explications"
        ></iframe>
      </div>

      <button id="push-start-btn" class="push-start-btn">üöÄ Commencer</button>
    </div>

    <div id="push-overlay" class="fullscreen-overlay">
      <div id="push-overlay-content"></div>
    </div>

    <button class="back-btn" id="back-push">‚¨Ö Retour</button>

    <footer>powered by <span>PhysiqueRUSH</span> ‚Äì Massive Impact</footer>
  </section>

  <!-- √âcran "Mon √âvolution" -->
  <section id="evolution-screen" class="screen">
    <img src="icon-512.png" alt="Logo PhysiqueRUSH" class="logo" />
    <h1>PhysiqueRUSH</h1>

    <div class="evolution-container">
      <p class="subtitle">
        Radar des 5 tests : Puissance de Pouss√©e, Capacit√© de Tirage, R√©sistance des Jambes,
        Potentiel Cardio, Niveau de D√©finition Musculaire (%BF). Chaque axe utilise ton <b>dernier</b> r√©sultat.
      </p>

      <canvas id="evolution-radar" width="320" height="320"></canvas>

      <p id="evo-legend" class="small-text">
        Va dans "La Test Room" pour enregistrer tes premiers tests.
      </p>
    </div>

    <button class="back-btn" id="back-evolution">‚¨Ö Retour</button>

    <footer>powered by <span>PhysiqueRUSH</span> ‚Äì Massive Impact</footer>
  </section>

  <script>
    /* ========= Navigation entre √©crans ========= */
    const screens = {
      main:      document.getElementById("main-screen"),
      niveau:    document.getElementById("niveau-screen"),
      testroom:  document.getElementById("testroom-screen"),
      push:      document.getElementById("push-screen"),
      evolution: document.getElementById("evolution-screen"),
    };

    function setActiveScreen(name) {
      Object.values(screens).forEach(s => s.classList.remove("active"));
      if (screens[name]) {
        screens[name].classList.add("active");
      }
    }

    const niveauBtn        = document.getElementById("niveau");
    const backNiveauBtn    = document.getElementById("back-niveau");
    const testroomBtn      = document.getElementById("testroom");
    const backTestroomBtn  = document.getElementById("back-testroom");
    const evolutionBtn     = document.getElementById("evolution");
    const backEvolutionBtn = document.getElementById("back-evolution");
    const backPushBtn      = document.getElementById("back-push");
    const pushStartBtn     = document.getElementById("push-start-btn");

    niveauBtn.addEventListener("click", () => setActiveScreen("niveau"));
    backNiveauBtn.addEventListener("click", () => setActiveScreen("main"));

    testroomBtn.addEventListener("click", () => {
      showTestroomMenu();
      setActiveScreen("testroom");
    });

    backTestroomBtn.addEventListener("click", () => setActiveScreen("niveau"));

    evolutionBtn.addEventListener("click", () => {
      setActiveScreen("evolution");
      updateRadarChart();
    });

    backEvolutionBtn.addEventListener("click", () => setActiveScreen("niveau"));

    backPushBtn.addEventListener("click", () => {
      clearPushInterval();
      if (pushPreIntervalId) {
        clearInterval(pushPreIntervalId);
        pushPreIntervalId = null;
      }
      document.getElementById("push-overlay").classList.remove("active");
      exitFullscreenLandscape();
      setActiveScreen("testroom");
    });

    // clic sur Commencer = plein √©cran + overlay directement sur palier 1
    pushStartBtn.addEventListener("click", () => {
      enterFullscreenLandscape();
      pushOverlay.classList.add("active");
      showPushLevel1Phase();
    });

    // Modules pas encore d√©velopp√©s
    document.getElementById("training").addEventListener("click", () => {
      alert("Module 'Training Camp' en construction üí•");
    });
    document.getElementById("improvise").addEventListener("click", () => {
      alert("Module 'S√©ance Improvis√©e' en construction üí•");
    });
    document.getElementById("historique").addEventListener("click", () => {
      alert("Module 'Historique des Perfs' en construction üí•");
    });

    /* ========= Stockage des tests ========= */
    const TEST_KEYS = [
      { key: "push",       label: "Puissance" },
      { key: "pull",       label: "Tirage" },
      { key: "legs",       label: "Jambes" },
      { key: "cardio",     label: "Cardio" },
      { key: "definition", label: "D√©finition" }
    ];
    const STORAGE_KEY = "physiqueRushTests";

    function loadTestData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.error("Erreur lecture stockage:", e);
        return {};
      }
    }

    function saveTestData(data) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error("Erreur √©criture stockage:", e);
      }
    }

    function bfToScore(bf) {
      const maxBF = 30;
      const minBF = 8;
      const clamped = Math.max(minBF, Math.min(maxBF, bf));
      const ratio01 = (maxBF - clamped) / (maxBF - minBF);
      return ratio01 * 10;
    }

    /* ========= La Test Room (formulaire manuel) ========= */
    const testroomMenu    = document.getElementById("testroom-menu");
    const testForm        = document.getElementById("test-form");
    const testNameEl      = document.getElementById("test-name");
    const testScoreInput  = document.getElementById("test-score");
    const saveTestBtn     = document.getElementById("save-test");
    const cancelTestBtn   = document.getElementById("cancel-test");
    let currentTestKey    = null;

    function showTestroomMenu() {
      testForm.style.display = "none";
      testroomMenu.style.display = "flex";
    }

    function showTestForm() {
      testroomMenu.style.display = "none";
      testForm.style.display = "flex";
    }

    document.querySelectorAll(".test-btn").forEach(btn => {
      const key = btn.dataset.test;

      if (key === "push") {
        btn.addEventListener("click", () => {
          setActiveScreen("push");
        });
      } else {
        btn.addEventListener("click", () => {
          currentTestKey = key;

          const fullText = btn.textContent.trim();
          const firstLine = fullText.split("\n")[0];
          testNameEl.textContent = firstLine;

          if (currentTestKey === "definition") {
            testScoreInput.placeholder = "Entre ton %BF (ex : 12.5)";
          } else {
            testScoreInput.placeholder = "Entre ton score (reps, paliers, etc.)";
          }

          testScoreInput.value = "";
          showTestForm();
        });
      }
    });

    saveTestBtn.addEventListener("click", () => {
      if (!currentTestKey) return;

      const rawVal = testScoreInput.value.replace(",", ".");
      const val = parseFloat(rawVal);

      if (isNaN(val) || val <= 0) {
        alert("Merci d'entrer une valeur num√©rique positive.");
        return;
      }

      const data = loadTestData();
      data[currentTestKey] = val;
      saveTestData(data);

      alert("Test sauvegard√© ‚úÖ");
      currentTestKey = null;
      showTestroomMenu();
    });

    cancelTestBtn.addEventListener("click", () => {
      currentTestKey = null;
      showTestroomMenu();
    });

    /* ========= Radar 'Mon √âvolution' ========= */
    function updateRadarChart() {
      const canvas = document.getElementById("evolution-radar");
      const legendEl = document.getElementById("evo-legend");
      if (!canvas) return;

      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      const rawData = loadTestData();

      const values = TEST_KEYS.map(t => {
        const v = rawData[t.key];
        if (!v || v <= 0) return 0;
        if (t.key === "definition") return bfToScore(v);
        return v;
      });

      const hasData = values.some(v => v > 0);

      if (!hasData) {
        legendEl.textContent =
          'Aucune donn√©e pour l\'instant. Va dans "La Test Room" pour enregistrer tes premiers tests.';
        return;
      } else {
        let txt = "Chaque axe repr√©sente ton dernier r√©sultat pour chaque test.";
        if (rawData.definition) {
          txt += " Axe D√©finition bas√© sur ton %BF actuel (" + rawData.definition + " %).";
        }
        legendEl.textContent = txt;
      }

      const cx = w / 2;
      const cy = h / 2;
      const radius = Math.min(w, h) * 0.35;
      const maxValue = Math.max(10, ...values);

      ctx.save();
      ctx.translate(cx, cy);

      ctx.strokeStyle = "#552222";
      ctx.lineWidth = 1;
      const steps = 4;
      for (let s = 1; s <= steps; s++) {
        const r = (radius * s) / steps;
        ctx.beginPath();
        ctx.arc(0, 0, r, 0, Math.PI * 2);
        ctx.stroke();
      }

      const n = TEST_KEYS.length;
      ctx.font = "12px Poppins, Arial";
      ctx.fillStyle = "#ffffff";

      TEST_KEYS.forEach((t, i) => {
        const angle = (Math.PI * 2 * i) / n - Math.PI / 2;
        const x = Math.cos(angle) * radius;
        const y = Math.sin(angle) * radius;

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(x, y);
        ctx.stroke();

        const lx = Math.cos(angle) * (radius + 16);
        const ly = Math.sin(angle) * (radius + 16);
        ctx.textAlign = lx > 0 ? "left" : "right";
        ctx.textBaseline = ly > 0 ? "top" : "bottom";
        ctx.fillText(t.label, lx, ly);
      });

      ctx.beginPath();
      values.forEach((val, i) => {
        const ratio = val / maxValue;
        const angle = (Math.PI * 2 * i) / n - Math.PI / 2;
        const r = radius * ratio;
        const x = Math.cos(angle) * r;
        const y = Math.sin(angle) * r;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.closePath();
      ctx.fillStyle = "rgba(255,80,80,0.35)";
      ctx.strokeStyle = "#ff5555";
      ctx.lineWidth = 2;
      ctx.fill();
      ctx.stroke();

      ctx.restore();
    }

    /* ========= Plein √©cran + orientation paysage ========= */
    async function enterFullscreenLandscape() {
      const elem = document.documentElement;
      try {
        if (elem.requestFullscreen) {
          await elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen();
        }
        if (screen.orientation && screen.orientation.lock) {
          try {
            await screen.orientation.lock('landscape');
          } catch (e) {
            console.warn('Orientation lock non support√©e ou refus√©e.', e);
          }
        }
      } catch (e) {
        console.warn('Erreur plein √©cran :', e);
      }
    }

    async function exitFullscreenLandscape() {
      try {
        if (document.fullscreenElement || document.webkitFullscreenElement) {
          if (document.exitFullscreen) {
            await document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          }
        }
        if (screen.orientation && screen.orientation.unlock) {
          screen.orientation.unlock();
        }
      } catch (e) {
        console.warn('Erreur sortie plein √©cran :', e);
      }
    }

    /* ========= Test Puissance de Pouss√©e (guid√©) ========= */
    const pushOverlay = document.getElementById("push-overlay");
    const pushOverlayContent = document.getElementById("push-overlay-content");
    let pushInterval = null;       // chrono 1 min
    let pushPreIntervalId = null;  // pr√©-compte 5 s
    let pushTimeLeft = 0;
    let pushLevel1Validated = false;
    let audioCtx = null;
    let pushVimeoPlayer = null;

    function clearPushInterval() {
      if (pushInterval) {
        clearInterval(pushInterval);
        pushInterval = null;
      }
    }

    function playBeep() {
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        if (!audioCtx) audioCtx = new AC();

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.type = "sine";
        osc.frequency.value = 1000;

        const now = audioCtx.currentTime;
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.25);

        osc.start(now);
        osc.stop(now + 0.3);
      } catch (e) {
        console.warn("Beep error", e);
      }
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
    }

    function showPushLevel1Phase() {
      pushOverlayContent.innerHTML = `
        <p class="push-phase-text" id="push-phase-text">
          Mets la vid√©o sur Lecture pour lancer le test...
        </p>

        <div class="push-video-row">
          <div class="push-mini-video-wrapper">
            <iframe
              id="push-demo-video"
              src="https://player.vimeo.com/video/474104138?muted=1&playsinline=1"
              allow="autoplay; fullscreen; picture-in-picture"
              allowfullscreen
              title="D√©monstration pompes Dead Stop"
            ></iframe>
          </div>
          <div class="push-palier-label" id="push-palier-label">
            Palier 1 = 10 Pompes Dead Stop
          </div>
        </div>

        <div class="push-count-row">
          <span class="push-count-label" id="push-count-label">Lancement dans :</span>
          <div class="push-level-count" id="push-level-count">5</div>
        </div>

        <div class="push-actions">
          <button class="push-ok-btn" id="push-ok-btn">‚úÖ Valid√©</button>
          <button class="push-fail-btn" id="push-fail-btn">‚ùå Non valid√©</button>
        </div>

        <p class="small-text push-next-text" id="push-next-palier-text"></p>
      `;

      const txtEl       = document.getElementById("push-phase-text");
      const palierEl    = document.getElementById("push-palier-label");
      const countLabel  = document.getElementById("push-count-label");
      const countEl     = document.getElementById("push-level-count");
      const okBtn       = document.getElementById("push-ok-btn");
      const failBtn     = document.getElementById("push-fail-btn");
      const nextTextEl  = document.getElementById("push-next-palier-text");
      const iframe      = document.getElementById("push-demo-video");

      if (pushPreIntervalId) {
        clearInterval(pushPreIntervalId);
        pushPreIntervalId = null;
      }
      clearPushInterval();

      let preStarted = false;
      let mainStarted = false;

      function startPreCountdown() {
        if (preStarted) return;
        preStarted = true;

        let preRemaining = 5;
        countLabel.textContent = "Lancement dans :";
        countEl.textContent = String(preRemaining);

        pushPreIntervalId = setInterval(() => {
          preRemaining--;
          if (preRemaining <= 0) {
            clearInterval(pushPreIntervalId);
            pushPreIntervalId = null;

            // la pastille "Palier 1 = 10 Pompes..." dispara√Æt visuellement
            palierEl.style.visibility = "hidden";

            // plus de texte "Lancement dans :"
            countLabel.textContent = "";

            // texte principal = consigne de palier
            txtEl.textContent = "Palier 1 : Vous avez 1 minute pour faire 10 pompes Dead Stop";

            startMainCountdown();
            return;
          }
          countEl.textContent = String(preRemaining);
        }, 1000);
      }

      function startMainCountdown() {
        if (mainStarted) return;
        mainStarted = true;

        pushTimeLeft = 60;
        countEl.textContent = formatTime(pushTimeLeft);

        clearPushInterval();
        pushInterval = setInterval(() => {
          if (pushTimeLeft <= 0) {
            clearPushInterval();
            countEl.textContent = "00:00";
            return;
          }

          pushTimeLeft--;
          countEl.textContent = formatTime(pushTimeLeft);

          if (pushTimeLeft > 0 && pushTimeLeft <= 3) {
            playBeep();
          }
        }, 1000);
      }

      okBtn.addEventListener("click", () => {
        if (okBtn.disabled || failBtn.disabled) return;
        pushLevel1Validated = true;
        okBtn.disabled = true;
        failBtn.disabled = true;

        txtEl.textContent = "Reposez-vous !";
        countLabel.textContent = "Prochain Palier dans :";
        nextTextEl.textContent = "Pr√©pare-toi pour le Palier 2 : 12 Pompes Dead Stop";
      });

      failBtn.addEventListener("click", () => {
        if (okBtn.disabled || failBtn.disabled) return;
        pushLevel1Validated = false;
        okBtn.disabled = true;
        failBtn.disabled = true;

        if (pushPreIntervalId) {
          clearInterval(pushPreIntervalId);
          pushPreIntervalId = null;
        }
        clearPushInterval();

        countEl.textContent = "00:00";
        countLabel.textContent = "";
        palierEl.style.visibility = "hidden";
        nextTextEl.textContent = "";
        txtEl.textContent = "Votre Puissance de pouss√©e est de NIVEAU 1";
      });

      if (window.Vimeo && typeof Vimeo.Player === "function") {
        try {
          pushVimeoPlayer = new Vimeo.Player(iframe);

          pushVimeoPlayer.setLoop(true);
          pushVimeoPlayer.setMuted(true);

          // Lancement du pr√©-compte uniquement quand la vid√©o entre en lecture
          pushVimeoPlayer.on("play", () => {
            startPreCountdown();
          });

          pushVimeoPlayer.ready().then(() => {
            pushVimeoPlayer.setCurrentTime(0);
          }).catch(err => {
            console.warn("Erreur Vimeo ready :", err);
            startPreCountdown();
          });
        } catch (e) {
          console.warn("Erreur Vimeo Player :", e);
          startPreCountdown();
        }
      } else {
        console.warn("API Vimeo non disponible, pr√©-compte lanc√© sans synchro vid√©o.");
        startPreCountdown();
      }
    }

    // PWA
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js")
        .then(() => console.log("Service Worker enregistr√©"))
        .catch(err => console.error("Erreur SW :", err));
    }
  </script>
</body>
</html>
